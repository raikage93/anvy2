name: Deploy to Contabo VPS (Advanced)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: eyeglasses-shop/package-lock.json

      - name: Install dependencies
        working-directory: ./eyeglasses-shop
        run: npm ci

      - name: Run linter
        working-directory: ./eyeglasses-shop
        run: npm run lint

      - name: Build application
        working-directory: ./eyeglasses-shop
        run: npm run build

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event.inputs.skip_tests == 'true' || needs.test.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.VPS_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || 22 }}
        run: |
          ssh -p $VPS_PORT $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            echo "üöÄ Starting deployment..."
            
            cd /var/www/eyeglasses-shop
            
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            echo "üõë Stopping old containers..."
            docker compose down || true
            
            echo "üèóÔ∏è Building new image..."
            docker compose build --no-cache
            
            echo "üö¢ Starting new containers..."
            docker compose up -d
            
            echo "‚è≥ Waiting for containers to be healthy..."
            sleep 15
            
            echo "üìã Container status:"
            docker compose ps
            
            echo "üìã Recent logs:"
            docker compose logs --tail=50
            
            echo "üîç Health check..."
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful! Application is running."
            else
              echo "‚ö†Ô∏è  Health check failed, but deployment completed."
            fi
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above."
          # You can add Slack/Discord/Email notifications here

